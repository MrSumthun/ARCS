#!/usr/bin/env zsh
set -euo pipefail

usage() {
  echo "Usage: ./macOSBuild [--help]"
  echo
  echo "Builds a macOS one-file app using PyInstaller. Run on macOS."
}

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  usage
  exit 0
fi

if [[ "$(uname)" != "Darwin" ]]; then
  echo "Error: This script must be run on macOS (Darwin)."
  exit 1
fi

if ! command -v pyinstaller >/dev/null 2>&1; then
  echo "pyinstaller not found. Install with: pip3 install pyinstaller"
  exit 1
fi

NAME="${2:-ARCS}"
ICON="data/app.icns"
ADDDATA="data:./data"

# Resolve script and repo directories relative to this script so the script can be run from anywhere
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "Building ${NAME} (using spec at $REPO_ROOT/data/ARCS.spec) ..."
(cd "$REPO_ROOT" && pyinstaller "data/ARCS.spec") || { echo "Build failed"; exit 1; }

echo "Build finished. See the 'dist' directory for the ${NAME} bundle."